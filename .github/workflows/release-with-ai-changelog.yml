name: Release and Changelog

on:
  push:
    branches:
      - main

permissions:
  contents: write
  pull-requests: write

jobs:
  release-please:
    runs-on: ubuntu-latest
    outputs:
      release_created: ${{ steps.release.outputs.release_created }}
      tag_name: ${{ steps.release.outputs.tag_name }}
    steps:
      - id: release
        uses: googleapis/release-please-action@v4
        with:
          release-type: node
          package-name: vibesdk
          extra-files: |
            bun.lock

  ai-changelog:
    needs: release-please
    if: needs.release-please.outputs.release_created
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      id-token: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Get previous tag
        id: prev_tag
        run: |
          CURRENT_TAG="${{ needs.release-please.outputs.tag_name }}"
          PREV_TAG=$(git describe --tags --abbrev=0 "$CURRENT_TAG^" 2>/dev/null || echo "")
          echo "current_tag=$CURRENT_TAG" >> $GITHUB_OUTPUT
          echo "previous_tag=$PREV_TAG" >> $GITHUB_OUTPUT
      
      - name: Generate changelog with Claude
        uses: anthropics/claude-code-action@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            Generate a professional changelog for this release.
            
            Compare tags:
            - From: ${{ steps.prev_tag.outputs.previous_tag }}
            - To: ${{ steps.prev_tag.outputs.current_tag }}
            
            Get commits and changes:
            ```bash
            git log "${{ steps.prev_tag.outputs.previous_tag }}...${{ steps.prev_tag.outputs.current_tag }}" --pretty=format:"%s" | head -100 > /tmp/commits.txt
            git diff "${{ steps.prev_tag.outputs.previous_tag }}...${{ steps.prev_tag.outputs.current_tag }}" --shortstat > /tmp/stats.txt
            cat /tmp/commits.txt /tmp/stats.txt
            ```
            
            Generate changelog:
            1. Categorize: Added, Changed, Fixed, Security, Performance, Documentation
            2. Write clear, user-focused descriptions
            3. Explain impact and breaking changes
            4. Use concise bullet points
            5. Professional tone, no emojis
            6. Focus on what matters to users
            
            Save result to file:
            ```bash
            cat << 'CHANGELOG' > /tmp/changelog.md
            [YOUR_GENERATED_CHANGELOG_HERE]
            CHANGELOG
            ```
          
          claude_args: |
            --allowed-tools "Bash(git:*),Bash(cat:*),Bash(echo:*)"
            --max-turns 10
            --model claude-haiku-4-5-20251001
      
      - name: Check if changelog was generated
        id: check_changelog
        run: |
          if [ -f /tmp/changelog.md ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Enhance release notes
        if: steps.check_changelog.outputs.exists == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG_NAME="${{ needs.release-please.outputs.tag_name }}"
          CURRENT_BODY=$(gh release view "$TAG_NAME" --json body -q .body)
          
          # Create new release notes file
          cat > /tmp/release-notes.md << 'EOF'
          ## Summary
          
          EOF
          
          # Append AI-generated changelog
          cat /tmp/changelog.md >> /tmp/release-notes.md
          
          # Add separator and original notes
          cat >> /tmp/release-notes.md << 'EOF'
          
          ---
          
          ## Detailed Changes
          
          EOF
          
          # Append current body without variable expansion
          echo "$CURRENT_BODY" >> /tmp/release-notes.md
          
          # Update release
          gh release edit "$TAG_NAME" --notes-file /tmp/release-notes.md
