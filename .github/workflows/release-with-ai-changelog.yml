name: Release and Changelog

on:
  push:
    branches:
      - main

permissions:
  contents: write
  pull-requests: write

jobs:
  release-please:
    runs-on: ubuntu-latest
    outputs:
      release_created: ${{ steps.release.outputs.release_created }}
      tag_name: ${{ steps.release.outputs.tag_name }}
    steps:
      - id: release
        uses: googleapis/release-please-action@v4
        with:
          release-type: node
          package-name: vibesdk
          extra-files: |
            bun.lock

  ai-changelog:
    needs: release-please
    if: needs.release-please.outputs.release_created
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Get previous tag
        id: prev_tag
        run: |
          CURRENT_TAG="${{ needs.release-please.outputs.tag_name }}"
          PREV_TAG=$(git describe --tags --abbrev=0 "$CURRENT_TAG^" 2>/dev/null || echo "")
          echo "current_tag=$CURRENT_TAG" >> $GITHUB_OUTPUT
          echo "previous_tag=$PREV_TAG" >> $GITHUB_OUTPUT
      
      - name: Generate changelog with Claude
        id: changelog
        run: |
          FROM_TAG="${{ steps.prev_tag.outputs.previous_tag }}"
          TO_TAG="${{ steps.prev_tag.outputs.current_tag }}"
          
          if [ -z "$FROM_TAG" ]; then
            echo "No previous tag found, skipping changelog generation"
            echo "result=Initial release" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Get commit messages
          COMMITS=$(git log "$FROM_TAG..$TO_TAG" --pretty=format:"%s" | head -100)
          
          # Get diff stats
          DIFF_STATS=$(git diff "$FROM_TAG..$TO_TAG" --shortstat)
          
          # Create prompt for Claude
          cat > /tmp/prompt.txt << 'PROMPT'
          Analyze the following commits and generate a professional changelog.
          
          Commits:
          COMMITS_PLACEHOLDER
          
          Changes: DIFF_STATS_PLACEHOLDER
          
          Instructions:
          1. Categorize changes: Added, Changed, Fixed, Security, Performance, Documentation
          2. Write clear, user-focused descriptions
          3. Explain impact and breaking changes if any
          4. Use concise bullet points
          5. Be professional and direct
          6. Do NOT use emojis
          7. Focus on what matters to users
          
          Output only the changelog content in markdown format. Start immediately with category headings.
          PROMPT
          
          sed -i "s|COMMITS_PLACEHOLDER|$COMMITS|g" /tmp/prompt.txt
          sed -i "s|DIFF_STATS_PLACEHOLDER|$DIFF_STATS|g" /tmp/prompt.txt
          
          # Call Claude API
          RESPONSE=$(curl -s https://api.anthropic.com/v1/messages \
            -H "content-type: application/json" \
            -H "x-api-key: ${{ secrets.ANTHROPIC_API_KEY }}" \
            -H "anthropic-version: 2023-06-01" \
            -d @- << EOF
          {
            "model": "claude-sonnet-4-5-20250929",
            "max_tokens": 2000,
            "messages": [{
              "role": "user",
              "content": $(cat /tmp/prompt.txt | jq -Rs .)
            }]
          }
          EOF
          )
          
          # Extract content
          CHANGELOG=$(echo "$RESPONSE" | jq -r '.content[0].text')
          
          # Save to output
          echo "result<<CHANGELOG_EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "CHANGELOG_EOF" >> $GITHUB_OUTPUT
      
      - name: Enhance release notes
        if: steps.changelog.outputs.result != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          CURRENT_BODY=$(gh release view ${{ needs.release-please.outputs.tag_name }} --json body -q .body)
          
          gh release edit ${{ needs.release-please.outputs.tag_name }} --notes "$(cat << 'EOF'
          ## Summary
          
          ${{ steps.changelog.outputs.result }}
          
          ---
          
          ## Detailed Changes
          
          $CURRENT_BODY
          EOF
          )"
