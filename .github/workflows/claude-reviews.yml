name: Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

jobs:
  pr-description:
    name: Review PR Description
    if: |
      github.event_name == 'pull_request' &&
      (github.event.action == 'opened' || github.event.action == 'synchronize') &&
      github.event.pull_request.user.login != 'dependabot[bot]' &&
      !contains(github.event.pull_request.title, 'Release')
    
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      id-token: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Review and Update PR Description with Claude
        uses: anthropics/claude-code-action@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            Review and improve the PR description for PR #${{ github.event.pull_request.number }}.
            
            Read CLAUDE.md for project conventions. Only read docs/llm.md if you need detailed architecture information.
            
            First, check the current PR description:
            ```bash
            gh pr view ${{ github.event.pull_request.number }} --repo ${{ github.repository }} --json body --jq '.body'
            ```
            
            Then analyze the changes:
            ```bash
            gh pr diff ${{ github.event.pull_request.number }} --repo ${{ github.repository }}
            ```
            
            Evaluate the current description:
            - If empty: Generate a complete professional description
            - If present: Assess if it's comprehensive and well-structured
            
            A good PR description should follow this format:
            
            ## Summary
            Brief 1-2 sentence overview of what this PR accomplishes.
            
            ## Changes
            - List key changes made (be specific about files/components modified)
            - Focus on what changed, not how (code speaks for itself)
            - Group related changes together
            
            ## Motivation
            Why was this change needed? What problem does it solve?
            
            ## Testing
            - How can reviewers test this?
            - What scenarios should be verified?
            
            ## Breaking Changes (if any)
            List any breaking changes or migration steps required.
            
            ---
            
            <sub>**This PR description was automatically generated by [Claude Code](https://claude.ai)**</sub>
            
            ---
            
            **IMPORTANT: Check for related issues**
            First, get all open issues:
            ```bash
            gh issue list --repo ${{ github.repository }} --state open --json number,title,body --limit 50
            ```
            
            Analyze which issues this PR might address based on:
            - Changed files
            - Commit messages
            - Issue titles/descriptions matching the changes
            
            If you find related issues, add them to the description in a "Related Issues" section:
            ```markdown
            ## Related Issues
            - Fixes #123
            - Addresses #456
            - Partially resolves #789
            ```
            
            Decision Logic:
            1. If description is empty or just a placeholder ‚Üí Generate complete description with related issues
            2. If description is present but incomplete/vague ‚Üí Suggest improvements as a comment
            3. If description is comprehensive ‚Üí Check if related issues are linked, add them if missing
            
            To update the PR description:
            ```bash
            gh pr edit ${{ github.event.pull_request.number }} --repo ${{ github.repository }} --body "YOUR_GENERATED_DESCRIPTION"
            ```
            
            To suggest improvements (if description exists but needs work):
            First, minimize any old suggestion comments:
            ```bash
            OLD_SUGGESTIONS=$(gh api repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments --jq '[.[] | select(.user.login == "github-actions[bot]") | select(.body | startswith("## üìù PR Description Suggestions")) | .id]')
            if [ -n "$OLD_SUGGESTIONS" ]; then
              echo "$OLD_SUGGESTIONS" | jq -r '.[]' | while read comment_id; do
                gh api repos/${{ github.repository }}/issues/comments/$comment_id -X PATCH -f body="<details><summary>üîí Outdated suggestions</summary>\n\nSuperseded by newer suggestions.\n</details>"
              done
            fi
            ```
            Then post new suggestions:
            ```bash
            gh pr comment ${{ github.event.pull_request.number }} --repo ${{ github.repository }} --body "## üìù PR Description Suggestions\n\nYOUR_SUGGESTIONS_HERE"
            ```
            
            Guidelines:
            - Be concise and professional
            - Use markdown formatting
            - Do NOT use emojis in the description itself (only in suggestion comments)
            - Focus on substance over style
            - Highlight important architectural decisions
            - Note any new dependencies or patterns introduced
            - **ALWAYS include the disclaimer at the end**: <sub>**This PR description was automatically generated by [Claude Code](https://claude.ai)**</sub>
          
          claude_args: |
            --allowed-tools "Bash(gh pr view:*),Bash(gh pr diff:*),Bash(gh pr edit:*),Bash(gh pr comment:*),Bash(gh issue list:*),Bash(gh api:*)"
            --max-turns 20
            --model claude-haiku-4-5-20251001

  comprehensive-review:
    name: Code Quality & Security Review
    if: |
      github.event.pull_request.user.login != 'dependabot[bot]' &&
      !contains(github.event.pull_request.title, 'Release') &&
      (
        github.event_name == 'pull_request' || 
        (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
        (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude'))
      )
    
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
      id-token: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Run Comprehensive Review
        uses: anthropics/claude-code-action@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            Perform a comprehensive, thorough and accurate code quality and security review for PR #${{ github.event.pull_request.number }}.

            Read CLAUDE.md for project conventions. Only read docs/llm.md if you need detailed architecture information.

            **Code Quality Issues:**
            - Code quality, potential bugs, architecture alignment
            - Logical flaws, bugs, issues
            - Type safety (no 'any' allowed per project rules)
            - DRY principle violations
            - Testing coverage
            - Performance concerns

            **Security Issues:**
            - SQL injection risks
            - XSS vulnerabilities  
            - Authentication/authorization flaws
            - Insecure data handling
            - Dependency vulnerabilities
            - SSRF attacks
            - DNS rebinding attacks
            - Improper input validation
            - Secrets exposure
            
            Focus review on worker/, src/, and shared/ directories.
            
            **Review Guidelines:**
            - Be concise and professional
            - Only report actual issues worth addressing
            - Skip generic praise and obvious observations
            - Provide specific fix recommendations with code examples
            - Do NOT use emojis
            - Group findings by severity: Critical, High, Medium, Low
            
            **CRITICAL: You MUST post a review comment in ALL cases**
            Format your review as:
            ```markdown
            ## Code & Security Review
            
            ### Code Quality
            [Issues or "‚úÖ No significant issues found"]
            
            ### Security
            [Vulnerabilities or "‚úÖ No security vulnerabilities found"]
            
            ### Summary
            [Brief overall assessment]
            ```
            
            **Smart Comment Management:**
            1. Find ALL previous review comments from this bot:
               ```bash
               COMMENT_IDS=$(gh api repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments --jq '[.[] | select(.user.login == "github-actions[bot]") | select(.body | startswith("## Code & Security Review")) | .id] | join(" ")')
               ```

            2. If multiple old comments exist, minimize them (all but the most recent):
               ```bash
               if [ -n "$COMMENT_IDS" ]; then
                 COMMENT_ARRAY=($COMMENT_IDS)
                 TOTAL=${#COMMENT_ARRAY[@]}
                 if [ $TOTAL -gt 1 ]; then
                   # Minimize all but the last one
                   for ((i=0; i<$TOTAL-1; i++)); do
                     gh api repos/${{ github.repository }}/issues/comments/${COMMENT_ARRAY[$i]} -X PATCH -f body="<details><summary>üîí Outdated review (click to expand)</summary>\n\nThis review has been superseded by a newer one.\n</details>"
                   done
                 fi
                 LATEST_COMMENT=${COMMENT_ARRAY[$TOTAL-1]}
               fi
               ```

            3. Update latest comment if exists, otherwise create new:
               ```bash
               if [ -n "$LATEST_COMMENT" ]; then
                 gh api repos/${{ github.repository }}/issues/comments/$LATEST_COMMENT -X PATCH -f body="YOUR_REVIEW_HERE"
               else
                 gh pr comment ${{ github.event.pull_request.number }} --body "YOUR_REVIEW_HERE" --repo ${{ github.repository }}
               fi
               ```
            
            **CRITICAL FINAL STEP:**
            After completing your analysis, you MUST execute the comment management bash commands above.
            DO NOT finish without posting a review comment.
            Even if no issues are found, post the "‚úÖ No issues" message.
          
          claude_args: |
            --allowed-tools "Bash(gh issue view:*),Bash(gh search:*),Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*),Bash(gh api:*)"
            --max-turns 20
            --model claude-sonnet-4-5-20250929
